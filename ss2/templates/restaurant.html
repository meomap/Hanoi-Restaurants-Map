<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<title>Hanoi Restaurants Map</title>
	
  	<link rel="stylesheet" href="../static/dist/leaflet.css" />
  	<link rel="stylesheet" href="../static/styles/reset.css" />
  	<link rel="stylesheet" href="../static/styles/loading.css" />
  	<link rel="stylesheet" href="../static/styles/main.css" />
  	<script src="../static/scripts/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="../static/dist/leaflet.js"></script>
  	<script type="text/javascript" src="../static/scripts/map.js"></script>
	
</head>
<body>
	
	<div id="mapdiv"></div>
	
	<!-- Category Panel -->
	<div id="catpane">
		<div class="pane_title">
			<span id="cuisine">CUISINES</span>
			<span id="control_top">
				<a href=#>Show all</a>
				<a href=#>Hide all</a>
			</span>
		</div>
		{% if categories %}
			{% for item in categories %}
				<div class="cat_block">
					
					<div id="cat{{ item.cat.id }}" style="cursor:pointer">
					<span class="catname topcat">{{ item.cat.name|lower }}</span>
					 
					<input type="checkbox" name="category"	class="catbox" id="super_{{ item.cat.id }}"
						value="{{ item.cat.id }}"/><br/>
					</div>
					
					<div id="sub_{{ item.cat.id }}" class="sub_block">
						{% if item.sub_cats|length < 1 %}
						<div class="subcat" id="{{ item.cat.name|slugify}}">
							<span class="catname">{{ item.cat.name|lower }}</span> 
						</div>
						{% endif %}
						
						{% for cat in item.sub_cats %}
						<div class="subcat" id="{{ cat.name|slugify }}">
							<span class="catname">{{ cat.name|lower }}</span> 
							<input type="checkbox" name="category" 
								class="catbox sub_{{ item.cat.id }}" value="{{ cat.id }}"/>
						</div>
						{% endfor %}
					</div>
				</div>
			{% endfor %}
		{% endif %}
	</div>
	<!-- /Category Panel -->
	

	<!-- Navigation Panel -->
	<div id="navigation">
		<img id="ribbon" 
		src="static/images/ribbon.png" alt="Hanoi Restaurant"/>
		<div id="menu">
			<div class="search_bar">		
				<div class="search">		
				<a href=#>
					Find nearby
				</a>
	<!-- 			<input id="input_search"></input> -->
				</div>
				
				<ul class="search_menu">
					<li><a href=# id="find_nearby">Find nearby</a></li>
					<li><a href=# id="search_name">Search by name</a></li>
				</ul>
			</div>
			<div id="main_nav">
				<a href=# id="about">About</a>
				<a href=# id="contact">Contact Us</a>
			</div>
		</div>
		
	</div>
	<!-- /Navigation Panel -->
	
	<!-- Info Panel -->
	<div id="infopane">
		<div id="info_title">
			Restaurant Name
		</div>
		
		<div id="content_nav">
			<a href=# id="left_arrow"></a>
			<a href=# id="right_arrow"></a>
		
		</div>
		<div id="content">
			<div id="plain_text">Content here</div>			
		</div>

	</div>
	<!-- /Info Panel -->
	
	<!-- Loading icon -->
	<div id="loading">
		<span id="load_label">Loading route ...</span>
		<div id="circularG">
			<div id="circularG_1" class="circularG"></div>
			<div id="circularG_2" class="circularG"></div>
			<div id="circularG_3" class="circularG"></div>
			<div id="circularG_4" class="circularG"></div>
			<div id="circularG_5" class="circularG"></div>
			<div id="circularG_6" class="circularG"></div>
			<div id="circularG_7" class="circularG"></div>
			<div id="circularG_8" class="circularG"></div>
		</div>
	</div>
	<!-- /Loading icon -->

	<script type="text/javascript">
	// extra array to store categories icon object
	var cat_icon = {}
	for (var key in cat_image) {
		var image_link = "static/images/markers/"+ cat_image[key];
		
		// set background for categories at sidebar
		var link = "url('"+ image_link +"') no-repeat";
		// id is lowercase with space converted to hythen
		id = key.toLowerCase().replace(" ", "-");
		$("#"+id).css({"background":link});
			
			cat_icon[key] = new FoodIcon(image_link);
		}
	$('document').ready(function() {
		// check all categories when first load
	    $("div#catpane :checkbox").each(function() {
	        $(this).attr('checked', true);
	    });	
		
		// initialize the map on the "map" div
		var map = new L.Map('mapdiv');

		// create a CloudMade tile layer (or use other provider of your choice)
		var cloudmade = new L.TileLayer('http://{s}.tile.cloudmade.com/3ddc9a2dfaf740f3ade43a6388b92405/998/256/{z}/{x}/{y}.png', {
		    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
		    maxZoom: 18
		});

		// add the CloudMade layer to the map set the view to a given center and
		// zoom
		map.addLayer(cloudmade).setView(new L.LatLng(21.0263153973078510, 105.8437510728617800), 15);

		// add the route layer which represented by roads
		route_layer = new L.GeoJSON(null);
		map.addLayer(route_layer);
		
		// top level layer of restaurant point
		restaurant_layer = new L.GeoJSON(null);
		map.addLayer(restaurant_layer);
		
		// current location marker
		var markerLocation = new L.LatLng(21.02170, 105.84146);
		var currentMarker = new L.Marker(markerLocation, {'draggable':true});		
		map.addLayer(currentMarker);
		currentMarker.bindPopup("<b>Your Location</b>").openPopup();		
		
		// refresh restaurant GeoJSON layer
		function restaurant_refresh() {
			var bbox = map.getBounds().toBBoxString();
			var selectedCats = cats_get();
			var url = '/restaurant.json?bbox='+ bbox + "&cat=" + selectedCats;
			var count = 0;
			$.getJSON(url, function(data) {
				// clear previous geojson points
				restaurant_layer.clearLayers();
				$.each(data.features, function(i, feature){
					// set appropriate icon for feature
					var icon = cat_icon[feature.properties.cat_layer];
					restaurant_layer.on("featureparse", function(e){
		 					e.layer.setIcon(icon);
		 					e.layer.bindPopup(restaurant_details(e.properties));
		 				});
					// add geojson point to layer
					restaurant_layer.addGeoJSON(feature);
					
				});
			});
		}
		
		{% for item in categories %}
		
		// Listen for click on super categories
		$("#super_{{ item.cat.id }}").click(function() {
					// set super checked state to sub categories
					var checked = $(this).is(':checked');
			        $(".sub_{{ item.cat.id }}").each(function() {		        	
			        	$(this).attr('checked', checked);
			        });
			        
			        restaurant_refresh();
				});
				
		// Listen for click on sub categories
		$("div.subcat :checkbox").click(
				function() {
		        	// determine super checked state
		        	var all_checked = true;
		        	$(".sub_{{ item.cat.id }}").not(":checked").each(function() {
		        		all_checked = false;
		        	});
					$("#super_{{ item.cat.id }}").attr('checked', all_checked);
					
					restaurant_refresh();
				});
		
		// Toogle to expand sub menu
		$("#cat{{ item.cat.id }}").click(function() {
			$("#sub_{{ item.cat.id }}").slideToggle("slow");
		});
		{% endfor %}
	 	
		// listener when user spans aroung the map
		map.on('moveend', restaurant_refresh);
				
		
		// load points when page first loads
		restaurant_refresh(null);
		
		// pages navigation
		var dynamic_nav = {
			nav: 	$("#content_nav"),
			left: 	$("#left_arrow"),
			right:	$("#right_arrow"),
			hide: function() {
				this.nav.children("a").hide();
			},
			show: function() {
				this.nav.children("a").show();
			},
			bindClick: function(content, pages, height) {
				var index = 0;
				this.nav.children("a").each(function(ind, el) {
					$(this).bind("click.pagejump", function() {							
						if($(this).is("#left_arrow")) {
							index -= 1;
						}
						else {
							index += 1;
						}
						
						// set visible content
	 					content.animate({
						"margin-top": -(height*index)}, 
						500);
						
	 					// set visible nav
						dynamic_nav.show();
	 					if (index == 0) {
	 						dynamic_nav.left.hide();
	 					}
	 					else if (index == pages-1) {
	 						dynamic_nav.right.hide();
	 					}
	 					return false;
					});
				});
			},
			unbindClick: function() {
				this.nav.children("a").each(function(ind, el) {
					$(this).unbind("click.pagejump");
				});
			}
		}
		
		// Object for information pane
		var infoPane = {
			wrapper:		$("#infopane"),	
			title: 			$("#info_title"),
			content_pane:	$("#content"),
			// content_nav: $("#content_nav"),
			content_nav:	dynamic_nav,
			content_text:	$("#plain_text"),
			max_height:		230,
			max_length:		530,	// text length
			
			show: function() {
				this.wrapper.slideDown("fast");
			},
			
			hide: function() {
				this.wrapper.slideUp("fast");				
			},
			
			setTitle: function(text) {
				this.title.html(text);
			},
			
			setContent: function(html_text) {
				this.clear();
				this.appendContent(html_text);
				this.checkLength();
			},
			
			appendContent: function(html_text) {
				this.content_text.prepend(html_text);
			},
			
			checkLength: function() {
				this.reset();
				var current_height = this.content_text.height();
				if (current_height > this.max_height) {
					// handle long content
					// this.content_nav.show();
					this.content_pane.css({"height": this.max_height});
					
					var pages = Math.ceil(current_height/this.max_height);
					// var page_index = 0;
					this.content_nav.right.show();
					this.content_nav.bindClick(this.content_text, pages, 
							this.max_height);

				}
			},
			
			reset: function() {
				this.content_nav.hide();
				this.content_nav.unbindClick();
				this.content_pane.css({"height":"auto"});
				this.content_text.css({"margin-top": 0});
			},
			
			clear: function() {
				this.content_text.empty();
			}
		};
		
		function displayList(data, title) {
			infoPane.setTitle(title);
			infoPane.clear();
			var count = 0;
			
			$.each(data.features, function(i, feature){					
				// style for even row
				var row_style = "";
				if (count % 2) {
					row_style = "even"
				}					
				// prepend list to inside content tag
				infoPane.appendContent('<div class="list_item '+ row_style 
						+'"><a class="list_link" href=# id='+ feature.id 
						+'><span class="list_name">'+ feature.properties.name 
						+  '</span>' + '<span class="list_distance" >' 
						+ feature.properties.distance 
						+ '</span></a></div>');				
				count += 1;
				
				// listener to invoke route finding
				$("a#"+feature.id).click(function(e) {
					route(currentMarker.getLatLng().lng, currentMarker.getLatLng().lat, 
					feature.geometry.coordinates[0], feature.geometry.coordinates[1]);
				});
			});
			infoPane.show();
			infoPane.checkLength();
		}
		
		// display search functions
		$(".search_bar").hover(function(){
			$(".search_menu").show();
		}, function(){
			$(".search_menu").hide();
		});
		
		var search_wrapper = $('.search');
		// listener to find nearby restaurants
		$("#find_nearby").click(function(e) {		
			search_wrapper.empty();
			search_wrapper.prepend("<a href=#>Find nearby</a>");
			var location = currentMarker.getLatLng()
			var url = "/findnearby.json?location=" 
						+ location.lng + "," + location.lat;
			$.getJSON(url, function(data) {
				displayList(data, "Nearby Restaurants");
			});
			return false;
		});		
		
		
		// listener to find restaurants by name
		$("#search_name").click(function(e) {
			search_wrapper.empty();		
			search_wrapper.prepend('<a href=# id="input_submit"></a>');
			search_wrapper.prepend('<input id="input_search"></input>');
			$('#input_search').focus();
			
			$("#input_search").keyup(function(event){
			    if(event.keyCode == 13){
			        $("#input_submit").click();
			    }
			});
			
			$('#input_submit').click(function() {
				var pattern = $('#input_search').val();
				$('#input_search').val('');
				var location = currentMarker.getLatLng()
				var url = "/findrestaurants.json?name=" + pattern + "&location=" 
					+ location.lng + "," + location.lat;
				$.getJSON(url, function(data) {
					displayList(data, "Search Results");
				});
				return false;
			});
			return false;
		});
		// display restaurant description
		map.on('popupopen', function(e) {
			// retrieve restaurant decription
			var description = $(".description").text();
			var name = $(".place_name").html();
			if (name != null) {
			infoPane.show();
			infoPane.setTitle(name);	
			infoPane.setContent(description);
			}
		});
		
		map.on('popupclose', function(e) {
			infoPane.hide();
		});
		
		// static information
		$("a#about").click(function(){
			infoPane.show();
			infoPane.setTitle("About");	
			infoPane.setContent("This application is an interactive map of " +
					"popular restaurants/eating places in Hanoi. " +
					"Developed & designed by La Son Hai, Nguyen Dang Khoi.</br></br>" +
					"<b>Note:</b> This page is our python project & served for " +
					"study purpose only. We do not guarantee the correctness of " +
					"the contents on this page. The restaurants information are " +
					"attributed to website <a class='link' target='_blank' " +
					"href='http://tnhvietnam.xemzi.com/en/c/1/cat/11/" +
					"restaurants-hanoi'>TNH Hanoi</a>");
			return false;
		});
		$("a#contact").click(function(){
			infoPane.show();
			infoPane.setTitle("Contact Us");	
			infoPane.setContent("<b>Hanoi University</b></br>" +
					"Faculty of Information & Technology</br></br>" +
					"Contact us via one of the following methods: </br>" +
					"<span id='contact_block'>@email: <span class='right_block'>" +
					"<a class='link' href='mailto:shnt1221@gmail.com'>" +
					"shnt1221@gmail.com</a></br><a class='link' " +
					"href='mailto:dextermorgan2212@gmail.com'>" +
					"dextermorgan2212@gmail.com</a></span>"
					);
			return false;
		});
	});
	</script>
</body>
</html>